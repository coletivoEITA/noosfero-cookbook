server {
  listen <%= @server[:proxy_port] %>;
  <% if @ssl[:enable] %>
  listen 443 ssl <%= 'spdy' if @ssl[:spdy] %>;
  <% end %>

  server_name www.<%= @server_name %>;
  rewrite ^ $scheme://<%= @server_name %>$request_uri?;
}

<% @custom_domains.each do |domain| %>
server {
  listen <%= @server[:proxy_port] %>;
  <% if @ssl[:enable] %>
  listen 443 ssl <%= 'spdy' if @ssl[:spdy] %>;
  <% end %>

  server_name www.<%= domain %>;
  rewrite ^ $scheme://<%= domain %>$request_uri?;
}
<% end %>

upstream <%= @service_name %> {
  <% if @server[:backend] == 'unicorn' %>
  server unix:<%= @run_path %>/unicorn.sock;
  <% elsif @server[:backend] == 'thin' %>
  <% @server[:workers].times.each do |i| %>
  server http://127.0.0.1:<%= @server['port'].to_i + i %>;
  <% end %>
  <% end %>

  keepalive 64;
}

upstream <%= @service_name %>_cache {
  server http://<%= @cache[:address] %>:<%= @cache[:port] %>;

  keepalive 64;
}

server {
  listen <%= @server[:proxy_port] %>;
  <% if @server[:proxy_to_cache] %>
  listen 127.0.0.1:<%= @server[:proxy_backend_port] %>;
  <% end %>
  <% if @ssl[:enable] %>
  listen 443 ssl <%= 'default_server' if @ssl[:default] %> <%= 'spdy' if @ssl[:spdy] %>;
  <% end %>

  server_name <%= @server_name %> <%= @custom_domains.join ' ' %>;
  port_in_redirect off;
  root <%= @code_path %>/public;

  <% if @ssl[:enable] %>
  ssl_certificate <%= @ssl[:certificate] %>;
  ssl_certificate_key <%= @ssl[:certificate_key] %>;
  # only safe protocols
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  <% end %>

  access_log <%= @access_log_path %> combined;
  error_log <%= @error_log_path %>;

  <% if @ssl[:enable] and @ssl[:redirect_http] %>
  if ( $scheme = http ) {
    rewrite ^ https://$host$uri last;
  }
  <% end %>

  if (-f $document_root/maintenance.html) {
    return 503;
  }
  error_page 503 @maintenance;
  location @maintenance {
    rewrite ^(.*)$ /maintenance.html break;
  }

  location / {
  <% if not @server[:block_bots].empty? %>
    if ($http_user_agent = "") {
      return 403;
    }
    if ($http_user_agent = "-") {
      return 403;
    }
    if ($http_user_agent ~ (<%= @server[:block_bots].join '|' %>) ) {
      return 403;
    }
  <% end %>

  <% if @server[:proxy_to_cache] %>
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
    if ( $server_port = <%= @server[:proxy_port] %> ) {
      proxy_pass http://<%= @service_name %>_cache;
    }
  <% end %>

    try_files index.html $uri @proxy;
  }

  location @proxy {
  <% if @server['backend'] == 'unicorn' %>
    proxy_buffers               4 256k;
    proxy_buffer_size           256k;
    proxy_busy_buffers_size     256k;
    proxy_temp_file_write_size  256k;
  <% end %>

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;
    proxy_pass http://<%= @service_name %>;

  <% if @cache[:server] == 'proxy' %>
    proxy_cache <%= @cache[:key_zone] %>;
    proxy_cache_valid 200 <%= @cache[:expires] %>;
  <% end %>
  }
}
